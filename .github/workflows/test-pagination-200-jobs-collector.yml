name: Test Pagination with 200 Jobs (Collector)

on:
  workflow_run:
    workflows:
      - Test Pagination with 200 Jobs (Target)
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  # Collect telemetry from the 200-job workflow to validate pagination
  collect-telemetry:
    name: Collect Telemetry from 200 Jobs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v5

      # Create directory with proper permissions
      - name: Create log directory with proper permissions
        run: |
          mkdir -p collector-logs
          chmod 777 collector-logs

      # Start OpenTelemetry Collector manually
      - name: Start OpenTelemetry Collector
        run: |
          echo "Starting OpenTelemetry Collector with custom configuration..."
          docker run -d \
            --name otel-collector \
            -p 13133:13133 \
            -p 4318:4318 \
            -v ${{ github.workspace }}/.github/configs/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml:ro \
            -v ${{ github.workspace }}/collector-logs:/collector-logs \
            --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:13133/ || exit 1" \
            --health-interval 10s \
            --health-timeout 5s \
            --health-retries 3 \
            otel/opentelemetry-collector-contrib:0.131.0

      # Wait for collector to be healthy and ready
      - name: Wait for collector to be ready
        run: |
          echo "Waiting for OpenTelemetry Collector to be ready..."
          timeout 60s bash -c 'until docker ps | grep -q "healthy.*otel-collector"; do sleep 2; echo "Waiting for collector health check..."; done'
          echo "Collector is ready"

      # Execute the GitHub Action which sends telemetry data to the collector
      - name: Execute Action
        uses: ./
        env:
          OTEL_SERVICE_NAME: github-actions-opentelemetry
          OTEL_EXPORTER_OTLP_ENDPOINT: http://localhost:4318
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for file system operations
        run: |
          echo "Waiting for file writes to complete..."
          sleep 5

      # Verify that traces and metrics were collected
      - name: Verify telemetry files exist
        run: |
          if [ ! -f collector-logs/traces-exported-original.json ]; then
            echo "✗ Traces file not found"
            exit 1
          fi
          if [ ! -f collector-logs/metrics-exported-original.json ]; then
            echo "✗ Metrics file not found"
            exit 1
          fi
          echo "✓ Telemetry files found"

      # Count the number of job spans in the traces to verify pagination worked
      - name: Verify job count in traces
        run: |
          # Extract job spans from traces (spans with name starting with "job:")
          JOB_COUNT=$(jq '[.resourceSpans[]?.scopeSpans[]?.spans[]? | select(.name | startswith("job:"))] | length' collector-logs/traces-exported-original.json)
          echo "Found $JOB_COUNT job spans in traces"

          # We expect 200 jobs from the matrix
          if [ "$JOB_COUNT" -lt 200 ]; then
            echo "✗ Expected at least 200 job spans, but found only $JOB_COUNT"
            echo "This indicates pagination is not working correctly"
            exit 1
          fi

          echo "✓ Successfully collected telemetry for $JOB_COUNT jobs (pagination working)"

      # Upload collector logs as GitHub artifact for debugging
      - name: Upload collector logs as artifact
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: pagination-200-jobs-collector-logs
          path: collector-logs/
          retention-days: 5

      # Show final collector status and logs for debugging
      - name: Show collector debug info
        if: always()
        run: |
          echo "=== Final collector status ==="
          docker ps -a | grep otel-collector || echo "Collector container not found"

          echo "=== Complete collector logs ==="
          docker logs otel-collector || echo "Could not retrieve collector logs"

          echo "=== Job span count summary ==="
          jq '[.resourceSpans[]?.scopeSpans[]?.spans[]? | select(.name | startswith("job:"))] | length' collector-logs/traces-exported-original.json || echo "Could not count job spans"
